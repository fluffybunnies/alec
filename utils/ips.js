/*
http://www.iplocation.net
curl ipinfo.io/71.176.66.25
[{"t":1426224063.0214,"ip":"180.76.5.144","s":1},{"t":1426277993.7849,"ip":"71.176.66.25","s":1},{"t":1426313788.3481,"ip":"157.55.39.196","s":1},{"t":1426594729.9281,"ip":"100.43.91.14","s":1},{"t":1426631651.9683,"ip":"173.196.184.100","s":1},{"t":1426631684.8444,"ip":"173.196.184.100","s":1},{"t":1426631690.1303,"ip":"173.196.184.100","s":0},{"t":1428193600.2545,"ip":"188.165.15.121","s":1},{"t":1429141660.9116,"ip":"68.180.228.25","s":1},{"t":1430329435.1228,"ip":"100.43.81.138","s":1},{"t":1430662426.4459,"ip":"66.249.64.169","s":1},{"t":1430928654.937,"ip":"66.249.64.254","s":1},{"t":1431730402.6458,"ip":"66.249.64.137","s":1},{"t":1431928471.4415,"ip":"217.69.133.249","s":1},{"t":1432242602.7239,"ip":"66.249.64.131","s":1},{"t":1432444476.0509,"ip":"66.249.67.4","s":1},{"t":1432670900.6105,"ip":"66.249.67.17","s":1},{"t":1432770465.3929,"ip":"180.76.15.157","s":1},{"t":1432774319.2184,"ip":"100.43.81.138","s":1},{"t":1432982483.3089,"ip":"66.249.65.198","s":1},{"t":1433148034.9685,"ip":"180.76.15.139","s":1},{"t":1433400239.4695,"ip":"66.249.67.4","s":1},{"t":1433597620.8957,"ip":"66.249.67.4","s":1},{"t":1434345137.3704,"ip":"68.180.228.25","s":1},{"t":1434785036.3719,"ip":"66.249.67.125","s":1},{"t":1434912297.7476,"ip":"100.43.81.156","s":1}]
*/

var http = require('http');
getIpInfo.maxConcurrent = 1;
getIpInfo.active = 10;
getIpInfo.queue = [];


/*run(
	[{"t":1426224063.0214,"ip":"180.76.5.144","s":1},{"t":1426277993.7849,"ip":"71.176.66.25","s":1},{"t":1426313788.3481,"ip":"157.55.39.196","s":1},{"t":1426594729.9281,"ip":"100.43.91.14","s":1},{"t":1426631651.9683,"ip":"173.196.184.100","s":1},{"t":1426631684.8444,"ip":"173.196.184.100","s":1},{"t":1426631690.1303,"ip":"173.196.184.100","s":0},{"t":1428193600.2545,"ip":"188.165.15.121","s":1},{"t":1429141660.9116,"ip":"68.180.228.25","s":1},{"t":1430329435.1228,"ip":"100.43.81.138","s":1},{"t":1430662426.4459,"ip":"66.249.64.169","s":1},{"t":1430928654.937,"ip":"66.249.64.254","s":1},{"t":1431730402.6458,"ip":"66.249.64.137","s":1},{"t":1431928471.4415,"ip":"217.69.133.249","s":1},{"t":1432242602.7239,"ip":"66.249.64.131","s":1},{"t":1432444476.0509,"ip":"66.249.67.4","s":1},{"t":1432670900.6105,"ip":"66.249.67.17","s":1},{"t":1432770465.3929,"ip":"180.76.15.157","s":1},{"t":1432774319.2184,"ip":"100.43.81.138","s":1},{"t":1432982483.3089,"ip":"66.249.65.198","s":1},{"t":1433148034.9685,"ip":"180.76.15.139","s":1},{"t":1433400239.4695,"ip":"66.249.67.4","s":1},{"t":1433597620.8957,"ip":"66.249.67.4","s":1},{"t":1434345137.3704,"ip":"68.180.228.25","s":1},{"t":1434785036.3719,"ip":"66.249.67.125","s":1},{"t":1434912297.7476,"ip":"100.43.81.156","s":1}]
);*/

run(
	'[{"t":1426224063.0214,"ip":"180.76.5.144","s":1},{"t":1426277993.7849,"ip":"71.176.66.25","s":1},{"t":1426313788.3481,"ip":"157.55.39.196","s":1},{"t":1426594729.9281,"ip":"100.43.91.14","s":1},{"t":1426631651.9683,"ip":"173.196.184.100","s":1},{"t":1426631684.8444,"ip":"173.196.184.100","s":1},{"t":1426631690.1303,"ip":"173.196.184.100","s":0},{"t":1428193600.2545,"ip":"188.165.15.121","s":1},{"t":1429141660.9116,"ip":"68.180.228.25","s":1},{"t":1430329435.1228,"ip":"100.43.81.138","s":1},{"t":1430662426.4459,"ip":"66.249.64.169","s":1},{"t":1430928654.937,"ip":"66.249.64.254","s":1},{"t":1431730402.6458,"ip":"66.249.64.137","s":1},{"t":1431928471.4415,"ip":"217.69.133.249","s":1},{"t":1432242602.7239,"ip":"66.249.64.131","s":1},{"t":1432444476.0509,"ip":"66.249.67.4","s":1},{"t":1432670900.6105,"ip":"66.249.67.17","s":1},{"t":1432770465.3929,"ip":"180.76.15.157","s":1},{"t":1432774319.2184,"ip":"100.43.81.138","s":1},{"t":1432982483.3089,"ip":"66.249.65.198","s":1},{"t":1433148034.9685,"ip":"180.76.15.139","s":1},{"t":1433400239.4695,"ip":"66.249.67.4","s":1},{"t":1433597620.8957,"ip":"66.249.67.4","s":1},{"t":1434345137.3704,"ip":"68.180.228.25","s":1},{"t":1434785036.3719,"ip":"66.249.67.125","s":1},{"t":1434912297.7476,"ip":"100.43.81.156","s":1}]'
);


function run(input){
	var ips = parseInput(input);
	applyIpInfo(ips,function(){
		console.log(ips);
	});
}

function parseInput(input){
	var ips = {};
	if (Array.isArray(input)) {
		input.forEach(function(v){
			if (!ips[v.ip])
				ips[v.ip] = {n:0,t:[]};
			++ips[v.ip].n;
			if (v.t)
				ips[v.ip].t.push(new Date(v.t*1000));
		});
	} else if (typeof input == 'string') {
		var re = /ip.*?([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})/ig, m;
		ips = [];
		while (m = re.exec(input)) {
			if (m[1])
				ips.push({ip:m[1]});
		}
		return parseInput(ips);
	}
	return ips;
}

function applyIpInfo(ips,cb){
	var numRequested = 0
		,numReceived = 0
	Object.keys(ips).forEach(function(k){
		++numRequested;
		getIpInfo(k,function(err,data){
			ips[k].i = err || data;
			if (++numReceived == numRequested)
				cb();
		});
	});
}

function getIpInfo(ip,cb){
	//if (getIpInfo.active == getIpInfo.maxConcurrent) console.log('queueing...');
	if (getIpInfo.active == getIpInfo.maxConcurrent)
		return getIpInfo.queue.push(arguments);
	++getIpInfo.active;
	http.get({
		host: 'ipinfo.io'
		,path: '/'+ip
	},function(res){
		var body = new Buffer(0)
		res.on('data',function(data){
			body = Buffer.concat([body,data]);
		});
		res.on('end',function(){
			try {
				body = JSON.parse(body.toString());
				cb(false, body);
			} catch (e) {
				cb(e);
			}
			--getIpInfo.active;
			//if (getIpInfo.queue[0]) console.log('grabbing next from queue...');
			if (getIpInfo.queue[0])
				getIpInfo.apply(null,getIpInfo.queue.shift());
		});
	});
}